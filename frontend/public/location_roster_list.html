<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Roster List · Tenant Dashboard</title>
    <link rel="stylesheet" href="/ui.css" />
    <style>
      body { background: var(--color-background); color: #e2e8f0; }
      .page { max-width: 1180px; margin: 0 auto 64px; padding: 28px 18px; }
      .page h1 { font-family: var(--font-heading); margin: 0; }
      .page__header { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: flex-start; margin-bottom: 14px; }
      .page__intro { color: #cbd5e1; margin: 6px 0 0; max-width: 720px; }
      .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 16px 0; }
      .roster-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
      .roster-card { background: rgba(255, 255, 255, 0.96); color: var(--color-strong); border-radius: var(--radius-md); padding: 16px; border: 1px solid var(--color-border); box-shadow: var(--shadow-md); display: flex; flex-direction: column; gap: 8px; }
      .roster-card h3 { margin: 0; font-family: var(--font-heading); }
      .roster-meta { display: flex; flex-wrap: wrap; gap: 8px; color: var(--color-muted); }
      .actions { display: flex; gap: 8px; flex-wrap: wrap; }
      .small-label { font-size: 12px; color: var(--color-muted); letter-spacing: 0.05em; text-transform: uppercase; }
      .pill { background: rgba(37, 99, 235, 0.12); color: #1d4ed8; padding: 6px 10px; border-radius: 999px; font-weight: 700; }
      .icon-note { color: #cbd5e1; font-size: 13px; }
    </style>
  </head>
  <body>
    <nav class="top-nav">
      <div class="top-nav__inner">
        <div class="brand">
          <span class="brand__title">Roster SaaS</span>
          <span class="brand__subtitle">Tenant roster list</span>
        </div>
        <div class="top-nav__links">
          <a class="nav-link" data-nav="home" href="/index.html">Home</a>
          <a class="nav-link" data-nav="dashboard" href="/location_roster_list.html">Tenant Dashboard</a>
          <a class="nav-link" data-nav="builder" href="/location_roster_builder.html">Roster Builder</a>
          <a class="nav-link" data-nav="list" href="/location_roster_list.html">Roster List</a>
          <a class="nav-link" data-nav="reports" href="/roster_reports_dashboard.html">Reports</a>
        </div>
      </div>
    </nav>

    <main class="page">
      <div class="page__header">
        <div>
          <h1>Roster Deployment Workspace</h1>
          <p class="page__intro">Browse every saved roster for this tenant, reopen drafts for edits, or open printable views.</p>
          <p class="icon-note">Place icons named <strong>list.svg</strong> and <strong>dashboard.svg</strong> inside <code>frontend/public/icons/</code> to show next to the page title.</p>
        </div>
        <div class="actions">
          <a class="btn btn-secondary" data-link="/location_roster_builder.html">Create New Roster</a>
          <a class="btn btn-ghost" data-link="/roster_print.html">Print Center</a>
        </div>
      </div>

      <div class="filter-bar">
        <div class="input-field">
          <label for="searchInput">Search</label>
          <input id="searchInput" type="search" placeholder="Search by title or location" />
        </div>
        <div class="input-field">
          <label for="yearFilter">Year</label>
          <input id="yearFilter" type="number" min="2000" max="2100" placeholder="All years" />
        </div>
        <div class="input-field">
          <label for="monthFilter">Month</label>
          <select id="monthFilter">
            <option value="">All months</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="input-field">
          <label for="tenantInput">Tenant</label>
          <input id="tenantInput" type="text" placeholder="Tenant ID" />
        </div>
        <div class="input-field" style="align-self:end;">
          <button id="resetFilters" class="btn btn-outline" type="button">Reset</button>
        </div>
      </div>

      <div id="rosterContainer" class="roster-grid"></div>
      <p id="emptyState" class="empty-state" hidden>No rosters found for this tenant.</p>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const tenantFromQuery = params.get('tenant');
      const storedTenant = localStorage.getItem('rosterTenantId');
      const tenantInput = document.getElementById('tenantInput');
      const rosterContainer = document.getElementById('rosterContainer');
      const emptyState = document.getElementById('emptyState');
      const searchInput = document.getElementById('searchInput');
      const yearFilter = document.getElementById('yearFilter');
      const monthFilter = document.getElementById('monthFilter');
      const resetButton = document.getElementById('resetFilters');

      function currentTenant() {
        const id = (tenantInput.value || tenantFromQuery || storedTenant || '').trim();
        if (id) localStorage.setItem('rosterTenantId', id);
        return id;
      }

      function updateNavLinks() {
        const tenant = currentTenant();
        document.querySelectorAll('[data-nav], [data-link]').forEach((anchor) => {
          const href = anchor.getAttribute('href') || anchor.getAttribute('data-link');
          if (!href) return;
          const url = tenant ? `${href}?tenant=${encodeURIComponent(tenant)}` : href;
          if (anchor.hasAttribute('href')) {
            anchor.setAttribute('href', url);
          } else {
            anchor.onclick = () => (window.location.href = url);
          }
        });
      }

      async function fetchRosters() {
        const tenant = currentTenant();
        if (!tenant) {
          rosterContainer.innerHTML = '';
          emptyState.hidden = false;
          emptyState.textContent = 'Enter a tenant ID to load rosters.';
          return;
        }

        try {
          const response = await fetch('/api/roster', {
            headers: { 'x-tenant-id': tenant }
          });
          const data = await response.json();
          renderRosters(Array.isArray(data) ? data : []);
        } catch (error) {
          rosterContainer.innerHTML = `<p class="notice">Failed to load rosters: ${error.message}</p>`;
          emptyState.hidden = true;
        }
      }

      function renderRosters(rosters) {
        const query = (searchInput.value || '').toLowerCase();
        const year = yearFilter.value;
        const month = monthFilter.value;
        let visible = 0;

        rosterContainer.innerHTML = rosters
          .filter((roster) => {
            const text = `${roster.name || ''} ${roster.location || ''}`.toLowerCase();
            const matchesSearch = !query || text.includes(query);
            const start = roster.start_date || '';
            const matchesYear = !year || start.startsWith(`${year}-`);
            const matchesMonth = !month || start.slice(5, 7) === month;
            return matchesSearch && matchesYear && matchesMonth;
          })
          .map((roster) => {
            visible += 1;
            return `
              <article class="roster-card">
                <div class="small-label">${roster.location || 'Location pending'}</div>
                <h3>${roster.name || 'Roster'}</h3>
                <div class="roster-meta">
                  <span class="pill">${roster.shift_mode || 'rotation'}</span>
                  <span>${roster.start_date || '—'} → ${roster.end_date || '—'}</span>
                  ${roster.approved_by_role ? `<span>${roster.approved_by_role}</span>` : ''}
                </div>
                <div class="actions">
                  <a class="btn btn-primary" href="/location_roster_builder.html?tenant=${encodeURIComponent(currentTenant())}">Open</a>
                  <a class="btn btn-ghost" href="/roster_print.html?tenant=${encodeURIComponent(currentTenant())}">Print</a>
                </div>
              </article>
            `;
          })
          .join('');

        emptyState.hidden = visible > 0;
        if (!visible) {
          emptyState.textContent = 'No rosters match the current filters.';
        }
      }

      [searchInput, yearFilter, monthFilter].forEach((field) => {
        field.addEventListener('input', () => fetchRosters());
      });

      tenantInput.addEventListener('input', () => {
        updateNavLinks();
        fetchRosters();
      });

      resetButton.addEventListener('click', () => {
        searchInput.value = '';
        yearFilter.value = '';
        monthFilter.value = '';
        tenantInput.value = tenantFromQuery || storedTenant || '';
        updateNavLinks();
        fetchRosters();
      });

      tenantInput.value = tenantFromQuery || storedTenant || '';
      updateNavLinks();
      fetchRosters();
    </script>
  </body>
</html>
