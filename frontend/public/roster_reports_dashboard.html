<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Roster Reports Dashboard</title>
    <link rel="stylesheet" href="/ui.css" />
    <style>
      body { background: var(--color-background); color: #e2e8f0; }
      .page { max-width: 1200px; margin: 0 auto 64px; padding: 28px 18px; }
      .page h1 { margin: 0; font-family: var(--font-heading); }
      .page__intro { color: #cbd5e1; margin: 8px 0 0; max-width: 720px; }
      .page__header { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin: 16px 0; }
      .card { background: rgba(255, 255, 255, 0.96); color: var(--color-strong); border-radius: var(--radius-md); padding: 16px; border: 1px solid var(--color-border); box-shadow: var(--shadow-md); }
      .table-wrap { margin-top: 18px; }
    </style>
  </head>
  <body>
    <nav class="top-nav">
      <div class="top-nav__inner">
        <div class="brand">
          <span class="brand__title">Roster SaaS</span>
          <span class="brand__subtitle">Reports dashboard</span>
        </div>
        <div class="top-nav__links">
          <a class="nav-link" data-nav="home" href="/index.html">Home</a>
          <a class="nav-link" data-nav="dashboard" href="/location_roster_list.html">Tenant Dashboard</a>
          <a class="nav-link" data-nav="builder" href="/location_roster_builder.html">Roster Builder</a>
          <a class="nav-link" data-nav="list" href="/location_roster_list.html">Roster List</a>
          <a class="nav-link" data-nav="reports" href="/roster_reports_dashboard.html">Reports</a>
        </div>
      </div>
    </nav>

    <main class="page">
      <header class="page__header">
        <div>
          <h1>Roster Deployment Summary</h1>
          <p class="page__intro">Browse published rosters, open print views, or reopen schedules for edits.</p>
          <p class="icon-note">Place icons named <strong>reports.svg</strong> and <strong>dashboard.svg</strong> inside <code>frontend/public/icons/</code> to decorate this header.</p>
        </div>
      </header>

      <div class="grid">
        <div class="card">
          <div class="input-field">
            <label for="tenantInput">Tenant ID</label>
            <input id="tenantInput" type="text" placeholder="Tenant ID" />
          </div>
          <div class="input-field">
            <label for="locationFilter">Location</label>
            <input id="locationFilter" type="text" placeholder="All locations" />
          </div>
        </div>
        <div class="card">
          <div class="input-field">
            <label for="yearFilter">Year</label>
            <input id="yearFilter" type="number" min="2000" max="2100" placeholder="All years" />
          </div>
          <div class="input-field">
            <label for="monthFilter">Month</label>
            <select id="monthFilter">
              <option value="">All months</option>
              <option value="01">January</option>
              <option value="02">February</option>
              <option value="03">March</option>
              <option value="04">April</option>
              <option value="05">May</option>
              <option value="06">June</option>
              <option value="07">July</option>
              <option value="08">August</option>
              <option value="09">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
        </div>
        <div class="card">
          <p class="section-subtitle">Design system summary</p>
          <p class="card__hint">Headings: Poppins · Body: Inter</p>
          <p class="card__hint">Palette: Primary #2563eb, Secondary #7c3aed, Accent #10b981</p>
          <p class="card__hint">Buttons: .btn-primary, .btn-secondary, .btn-outline, .btn-danger</p>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table-shell" id="reportTable">
          <thead>
            <tr>
              <th>Location</th>
              <th>Title</th>
              <th>Period</th>
              <th>Shift Mode</th>
              <th>Print</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="emptyState" class="empty-state" hidden>No rosters available for this view.</p>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const tenantFromQuery = params.get('tenant');
      const storedTenant = localStorage.getItem('rosterTenantId');
      const tenantInput = document.getElementById('tenantInput');
      const locationFilter = document.getElementById('locationFilter');
      const yearFilter = document.getElementById('yearFilter');
      const monthFilter = document.getElementById('monthFilter');
      const tableBody = document.querySelector('#reportTable tbody');
      const emptyState = document.getElementById('emptyState');

      function currentTenant() {
        const id = (tenantInput.value || tenantFromQuery || storedTenant || '').trim();
        if (id) localStorage.setItem('rosterTenantId', id);
        return id;
      }

      function updateNavLinks() {
        const tenant = currentTenant();
        document.querySelectorAll('[data-nav]').forEach((link) => {
          const base = link.getAttribute('href');
          const url = tenant ? `${base}?tenant=${encodeURIComponent(tenant)}` : base;
          link.setAttribute('href', url);
        });
      }

      async function loadReports() {
        const tenant = currentTenant();
        if (!tenant) {
          tableBody.innerHTML = '';
          emptyState.hidden = false;
          emptyState.textContent = 'Enter a tenant ID to load reports.';
          return;
        }
        try {
          const response = await fetch('/api/roster', { headers: { 'x-tenant-id': tenant } });
          const data = await response.json();
          renderRows(Array.isArray(data) ? data : []);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="6">${error.message}</td></tr>`;
          emptyState.hidden = true;
        }
      }

      function renderRows(rows) {
        const location = (locationFilter.value || '').toLowerCase();
        const year = yearFilter.value;
        const month = monthFilter.value;
        let visible = 0;

        tableBody.innerHTML = rows
          .filter((row) => {
            const locMatches = !location || (row.location || '').toLowerCase().includes(location);
            const start = row.start_date || '';
            const matchesYear = !year || start.startsWith(`${year}-`);
            const matchesMonth = !month || start.slice(5, 7) === month;
            return locMatches && matchesYear && matchesMonth;
          })
          .map((row) => {
            visible += 1;
            const tenant = encodeURIComponent(currentTenant());
            const printLink = `/roster_print.html?tenant=${tenant}`;
            return `
              <tr>
                <td>${row.location || '—'}</td>
                <td>${row.name || 'Untitled roster'}</td>
                <td>${row.start_date || '—'} → ${row.end_date || '—'}</td>
                <td>${row.shift_mode || 'rotation'}</td>
                <td><a class="btn btn-primary" href="${printLink}">Print</a></td>
                <td>${row.updated_at || '—'}</td>
              </tr>
            `;
          })
          .join('');

        emptyState.hidden = visible > 0;
        if (!visible) {
          emptyState.textContent = 'No rosters match the current filters.';
        }
      }

      [tenantInput, locationFilter, yearFilter, monthFilter].forEach((field) => {
        field.addEventListener('input', () => {
          updateNavLinks();
          loadReports();
        });
      });

      tenantInput.value = tenantFromQuery || storedTenant || '';
      updateNavLinks();
      loadReports();
    </script>
  </body>
</html>
