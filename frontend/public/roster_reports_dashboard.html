{% extends 'admin/base_site.html' %}
{% load i18n static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/datatables/datatables.min.css' %}">
  <link rel="stylesheet" href="{% static 'vendor/datatables/buttons/buttons.dataTables.min.css' %}">
  <link rel="stylesheet" href="{% static 'reports/css/report_tables.css' %}">
  <style>
    .roster-dashboard { max-width: 1180px; margin: 0 auto 36px; padding: 16px; }
    .roster-dashboard h2 { margin-bottom: 8px; }
    .roster-dashboard .intro { color: #4b5563; margin-bottom: 20px; }
    .roster-dashboard .filters { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 18px; }
    .roster-dashboard .filter { display: flex; flex-direction: column; gap: 6px; }
    .roster-dashboard label { font-weight: 600; font-size: 13px; color: #1f2937; }
    .roster-dashboard select, .roster-dashboard input { padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-width: 180px; }
    .roster-dashboard .btn-apply { align-self: flex-end; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; background: #0c4b33; color: #fff; }
    .roster-dashboard .btn-reset { align-self: flex-end; padding: 8px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: 1px solid #0c4b33; background: #fff; color: #0c4b33; font-weight: 600; }
    .roster-dashboard .btn-reset:hover { background: #f0fdf4; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 999px; background: #e0f2fe; color: #075985; font-weight: 600; font-size: 12px; }
    .record-pill { display: inline-flex; flex-direction: column; gap: 6px; padding: 8px 12px; border-radius: 12px; background: #0f172a; color: #fff; font-weight: 600; font-size: 12px; line-height: 1.4; box-shadow: 0 12px 20px -18px rgba(15, 23, 42, 0.65); }
    .record-pill .badge { align-self: flex-start; margin-top: 4px; }
    @media (max-width: 768px) {
      .roster-dashboard .filters { flex-direction: column; }
      .roster-dashboard select, .roster-dashboard input { min-width: auto; }
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main" class="roster-dashboard module report-page-wrapper">
  <h2>{% trans "Roster Deployment Summary" %}</h2>
  <p class="intro">{% trans "Browse published rosters, open Form PAAF-100-OPAT-1.0 print views, or reopen schedules for edits." %}</p>

  <div class="filters">
    <div class="filter">
      <label for="filterLocation">{% trans "Location" %}</label>
      <select id="filterLocation">
        <option value="">{% trans "All locations" %}</option>
        {% for code in available_locations %}
          <option value="{{ code }}">{{ code }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter">
      <label for="filterYear">{% trans "Year" %}</label>
      <select id="filterYear">
        <option value="">{% trans "All years" %}</option>
        {% for year in available_years %}
          <option value="{{ year }}">{{ year }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter">
      <label for="filterMonth">{% trans "Month" %}</label>
      <select id="filterMonth">
        <option value="">{% trans "All months" %}</option>
        {% for value, label in month_choices %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter">
      <button type="button" class="btn-apply" id="applyFilters">{% trans "Apply" %}</button>
    </div>
    <div class="filter">
      <button type="button" class="btn-reset" id="resetFilters">{% trans "Reset" %}</button>
    </div>
  </div>

  <table id="rosterTable" class="display nowrap" style="width: 100%">
    <thead>
      <tr>
        <th>{% trans "Location" %}</th>
        <th>{% trans "Period" %}</th>
        <th>{% trans "Effective From" %}</th>
        <th>{% trans "Duration" %}</th>
        <th>{% trans "Cycle" %}</th>
        <th>{% trans "Developed" %}</th>
        <th>{% trans "Verified" %}</th>
        <th>{% trans "Approved" %}</th>
        <th>{% trans "Print" %}</th>
        <th>{% trans "Updated" %}</th>
      </tr>
    </thead>
  </table>
</div>

<script src="{% static 'vendor/jquery/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'vendor/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables/buttons/dataTables.buttons.min.js' %}"></script>
<script>
  (function() {
    const tableEl = $('#rosterTable');
    const locationSelect = document.getElementById('filterLocation');
    const yearSelect = document.getElementById('filterYear');
    const monthSelect = document.getElementById('filterMonth');
    const applyButton = document.getElementById('applyFilters');
    const resetButton = document.getElementById('resetFilters');

    function buildUrl() {
      const params = new URLSearchParams();
      if (locationSelect.value) params.append('location', locationSelect.value);
      if (yearSelect.value) params.append('year', yearSelect.value);
      if (monthSelect.value) params.append('month', monthSelect.value);
      const query = params.toString();
      return query ? (`{% url 'reports:roster_reports_dashboard_data' %}?` + query) : `{% url 'reports:roster_reports_dashboard_data' %}`;
    }

    const dataTable = tableEl.DataTable({
      dom: "<'report-toolbar'<'toolbar-group'l><'toolbar-group'f>>" + "<'table-responsive't>" + "<'report-footer'<'toolbar-group'i><'toolbar-group'p>>",
      scrollX: true,
      pageLength: 20,
      ajax: buildUrl(),
      columns: [
        { data: 'location' },
        {
          data: null,
          render: function(row) {
            return `<div class="record-pill" style="background:#0f172a;color:#fff">${row.title}<br><span class="badge" style="background:#e2e8f0;color:#1f2937">${row.period}</span></div>`;
          },
          orderable: false
        },
        {
          data: 'effective_from',
          render: function(value) {
            if (!value) return '';
            const date = new Date(value);
            return date.toLocaleDateString();
          }
        },
        {
          data: 'duration_days',
          render: function(value) {
            return value ? `${value} {% trans "days" %}` : '';
          }
        },
        {
          data: 'shift_cycle_length',
          render: function(value) {
            return value ? `${value} {% trans "day cycle" %}` : '';
          }
        },
        { data: 'developed_by' },
        { data: 'verified_by' },
        { data: 'approved_by' },
        {
          data: 'print_url',
          orderable: false,
          render: function(value) {
            if (!value) return '<span class="badge">{% trans "Unavailable" %}</span>';
            return `<a href="${value}" target="_blank" rel="noopener" class="badge" style="background:#22c55e;color:#064e3b">{% trans "Print" %}</a>`;
          }
        },
        {
          data: 'updated_at',
          render: function(value) {
            if (!value) return '';
            const date = new Date(value);
            return date.toLocaleString();
          }
        }
      ]
    });

    applyButton.addEventListener('click', function() {
      dataTable.ajax().url(buildUrl()).load();
    });

    resetButton.addEventListener('click', function() {
      locationSelect.value = '';
      yearSelect.value = '';
      monthSelect.value = '';
      dataTable.ajax().url(buildUrl()).load();
    });
  })();
</script>
{% endblock %}
